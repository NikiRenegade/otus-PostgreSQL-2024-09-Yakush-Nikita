# Отчет о выполнении домашнего задания
## Сбор и использование статистики 
Для выполнения данной ДЗ создал пять таблицы,
которые надуманно отражают БД otus курса "PostgreSQL для администраторов баз данных и разработчиков" 

### Таблицы:

#### 1 company - таблица компаний в которой работают обучающиеся

**Описание**

| Название столбца | Описание столбца |
|------------------|------------------|
| id               | id               |
| name             | Название         |

**Скрипт создания и заполнения**

```SQL
create table otus."company" (
                                "id" serial primary key,
                                "name" text not null
);

insert into otus."company" ("name")
values
    ('Яндекс'),
    ('Mail.ru Group'),
    ('Ozon'),
    ('Сбербанк'),
    ('Рамблер'),
    ('Т-банк'),
    ('1С'),
    ('МТС'),
    ('Газпром нефть'),
    ('Мегафон');


```

#### 2 student - таблица обучающихся на курсе

**Описание**

| Название столбца | Описание столбца  |
|------------------|-------------------|
| id               | id                |
| last_name        | Фамилия           |
| first_name       | Имя               |
| patronymic       | Отчество          |
| companyId        | id компании       |

**Скрипт создания и заполнения**

```SQL
create table otus."student" (
                                "id" serial primary key,
                                "lastName" text not null,
                                "firstName" text not null,
                                "patronymic" text not null,
                                "companyId" int,
                                constraint fk_company foreign key ("companyId") references otus.company ("id")
);

insert into otus."student"
    ("lastName", "firstName", "patronymic", "companyId" )
values
    ('Иванов', 'Пётр', 'Алексеевич',1),
    ('Смирнов', 'Алексей','Михайлович', 2),
    ('Кузнецов', 'Иван', 'Васильевич', null),
    ('Попов', 'Николай', 'Павлович', 3),
    ('Васильев', 'Михаил', 'Федорович', 4),
    ('Петров', 'Борис', 'Николаевич', null),
    ('Соколов', 'Леонид', 'Ильич', 5),
    ('Михайлов', 'Александр', 'Николаевич', 6),
    ('Фёдоров', 'Павел', 'Петрович', null),
    ('Волков', 'Владимир', 'Ильич', 7),
    ('Алексеев', 'Никита', 'Сергеевич', null),
    ('Лебедев', 'Борис', 'Федорович', 8),
    ('Семенов', 'Александр', 'Александрович', null),
    ('Егоров', 'Василий', 'Иванович', 9),
    ('Павлов', 'Федор', 'Алексеевич', 10);
```

#### 3 lecture - таблица которая содержит в себе список тем

**Описание**

| Название столбца | Описание столбца |
|------------------|------------------|
| id               | id               |
| name             | Название         |

**Скрипт создания и заполнения**

```SQL
create table otus."lecture" (
                                "id" serial primary key,
                                "name" text not null
);

insert into otus."lecture" ("name")
values
    ('Реляционные базы, история и место в современном мире'),
    ('SQL и реляционные СУБД. Введение в PostgreSQL'),
    ('Установка PostgreSQL'),
    ('Физический уровень PostgreSQL'),
    ('Логический уровень PostgreSQL'),
    ('Настройка PostgreSQL'),
    ('Блокировки'),
    ('MVCC, vacuum и autovacuum'),
    ('Журналы'),
    ('DDL: создание, изменение и удаление объектов в PostgreSQL'),
    ('Выборка данных, виды join''ов. Применение и оптимизация.'),
    ('DML: вставка, обновление, удаление'),
    ('Виды индексов. Работа с индексами и оптимизация запросов'),
    ('Продвинутые типы данных в PostgreSQL'),
    ('Секционирование'),
    ('Хранимые функции и процедуры часть 1'),
    ('Хранимые функции и процедуры часть 2'),
    ('Хранимые функции и процедуры часть 3'),
    ('Расширения PostgreSQL'),
    ('Резервное копирование и восстановление'),
    ('Виды и устройство репликации в PostgreSQL. Практика применения'),
    ('Кластер Patroni'),
    ('Сбор и использование статистики'),
    ('Оптимизация производительности. Профилирование. Мониторинг');
```

#### 4 homework - таблица которая содержит в себе список домашних заданий

**Описание**

| Название столбца   | Описание столбца   |
|--------------------|--------------------|
| id                 | id                 |
| text               | Текст ДЗ           |
| lectureId          | id темы            |

**Скрипт создания и заполнения**

```SQL
create table otus."homework" (
                                 "id" serial primary key,
                                 "text" text not null,
                                 "lectureId" int,
                                 constraint fk_lecture foreign key ("lectureId") references otus."lecture" ("id")
);


insert into otus."homework" ("text", "lectureId")
values
    ('Работа с уровнями изоляции транзакции в PostgreSQL', 2),
    ('Установка и настройка PostgteSQL в контейнере Docker', 3),
    ('Установка и настройка PostgreSQL', 4),
    ('Работа с базами данных, пользователями и правами', 5),
    ('Нагрузочное тестирование и тюнинг PostgreSQL', 6),
    ('Настройка autovacuum с учетом особеностей производительности', 7),
    ('Механизм блокировок', 8),
    ('Работа с журналами', 9),
    ('Работа с индексами', 13),
    ('Секционирование таблицы', 15),
    ('Триггеры, поддержка заполнения витрин', 18),
    ('Бэкапы', 20),
    ('Репликация', 21),
    ('Работа с join''ами, статистикой', 23);
```
#### 5 homeworkStatus - таблица которая содержит в себе информацию о выполненных ДЗ с количеством полученных баллов

**Описание**

| Название столбца          | Описание столбца |
|---------------------------|------------------|
| id                        | id               |
| studentId                 | id обучающегося  |
| homeworkId                | id дз            |
| score                     | кол-во баллов    |

**Скрипт создания и заполнения**

```SQL
create table otus."homeworkStatus" (
                                       "id" serial primary key,
                                       "studentId" int not null,
                                       "homeworkId" int not null,
                                       "score" int not null,
                                       constraint fk_student foreign key ("studentId") references otus.student ("id"),
                                       constraint fk_homework foreign key ("homeworkId") references otus.homework ("id")
);

-- Заполнение таблицы homework_status тестовыми данными
insert into otus."homeworkStatus" ("studentId", "homeworkId", "score")
values
    (1, 1, 15),
    (2, 1, 10),
    (2, 3, 10),
    (3, 4, 17),
    (4, 2, 15),
    (4, 5, 8),
    (5, 7, 10),
    (6, 9, 12),
    (7, 13, 15),
    (8, 14, 17);
```
1. Реализовать прямое соединение двух таблиц. Реализую показ только тех обучающихся, которые работают в компаниях из таблицы компаний:
```SQL
select
    s."lastName" ,
    s."firstName" ,
    s."patronymic" ,
    c."name" as "companyName"
from otus.student s
inner join otus.company c
on s."companyId" = c.id 
```
**Результат**

| lastName  | firstName  | patronymic  | companyName   |
|-----------|------------|-------------|---------------|
| Иванов    | Пётр       | Алексеевич  | Яндекс        |
| Попов     | Николай    | Павлович    | Ozon          |
| Васильев  | Михаил     | Федорович   | Сбербанк      |
| Соколов   | Леонид     | Ильич       | Рамблер       |
| Михайлов  | Александр  | Николаевич  | Т-банк        |
| Волков    | Владимир   | Ильич       | 1С            |
| Лебедев   | Борис      | Федорович   | МТС           |
| Егоров    | Василий    | Иванович    | Газпром нефть |
| Павлов    | Федор      | Алексеевич  | Мегафон       |
| Смирнов   | Алексей    | Михайлович  | Яндекс        |

2. Реализовать левостороннее соединение (left join). Реализую показ всех тем с их ДЗ если они есть:
```SQL
select
    l."name" as "lectureName",
    h."text" as "homeworkText"
from otus.lecture l
left join otus.homework h
on l.id = h."lectureId"
order by l.id
```
**Результат**

| lectureName                                                    | homeworkText                          |
|----------------------------------------------------------------|---------------------------------------|
| MVCC, vacuum и autovacuum                                      | Механизм блокировок                   |
| Журналы                                                        | Работа с журналами                    |
| DDL: создание, изменение и удаление объектов в PostgreSQL      |                                       |
| Выборка данных, виды join'ов. Применение и оптимизация.        |                                       |
| DML: вставка, обновление, удаление                             |                                       |
| Виды индексов. Работа с индексами и оптимизация запросов       | Работа с индексами                    |
| Продвинутые типы данных в PostgreSQL                           |                                       |
| Секционирование                                                | Секционирование таблицы               |
| Хранимые функции и процедуры часть 1                           |                                       |
| Хранимые функции и процедуры часть 2                           |                                       |
| Хранимые функции и процедуры часть 3                           | Триггеры, поддержка заполнения витрин |
| Расширения PostgreSQL                                          |                                       |
| Резервное копирование и восстановление                         | Бэкапы                                |
| Виды и устройство репликации в PostgreSQL. Практика применения | Репликация                            |
| Кластер Patroni                                                |                                       |
| Сбор и использование статистики                                | Работа с join'ами, статистикой        |
| Оптимизация производительности. Профилирование. Мониторинг     |                                       |

3. Реализовать кросс соединение (cross join). Реализую показ всех cтудентов, список тем, текст ДЗ, статус ДЗ (Сдано или не сдано) и кол-во баллов если оно есть. Так как у каждого студента есть каждая тема то необходимо использовать cross join:
```SQL
select
    s."lastName" 	as "studentLastName",
    s."firstName" 	as "studentFirstName",
    s.patronymic	as "studentPatronymic",
    l."name" 		as "lectureName",
    h."text" 		as "homeworkText",
    case when hs.score is null then 'ДЗ не сдано'
         else 'ДЗ сдано'
        end 	 		as "homeworkStatus",
    hs.score 		as "homeworkScore"
from otus.student s
         cross join otus.lecture l
         left join otus.homework h
                   on l.id = h."lectureId"
         left join otus."homeworkStatus" hs
                   on hs."studentId" = s.id
                       and hs."homeworkId" = h.id
order by case when hs.score is null then 2
              else 1 end,
         l.id,
         s."lastName" 
```
**Результат (частичный тк весь результат занимает 360 строк)**

| studentFirstName  | studentPatronymic  | lectureName                                                    | homeworkText                                         | homeworkStatus  | homeworkScore  |
|-------------------|--------------------|----------------------------------------------------------------|------------------------------------------------------|-----------------|----------------|
| Пётр              | Алексеевич         | SQL и реляционные СУБД. Введение в PostgreSQL                  | Работа с уровнями изоляции транзакции в PostgreSQL   | ДЗ сдано        | 15             |
| Алексей           | Михайлович         | SQL и реляционные СУБД. Введение в PostgreSQL                  | Работа с уровнями изоляции транзакции в PostgreSQL   | ДЗ сдано        | 10             |
| Николай           | Павлович           | Установка PostgreSQL                                           | Установка и настройка PostgteSQL в контейнере Docker | ДЗ сдано        | 15             |
| Алексей           | Михайлович         | Физический уровень PostgreSQL                                  | Установка и настройка PostgreSQL                     | ДЗ сдано        | 10             |
| Иван              | Васильевич         | Логический уровень PostgreSQL                                  | Работа с базами данных, пользователями и правами     | ДЗ сдано        | 17             |
| Николай           | Павлович           | Настройка PostgreSQL                                           | Нагрузочное тестирование и тюнинг PostgreSQL         | ДЗ сдано        | 8              |
| Михаил            | Федорович          | MVCC, vacuum и autovacuum                                      | Механизм блокировок                                  | ДЗ сдано        | 10             |
| Борис             | Николаевич         | Виды индексов. Работа с индексами и оптимизация запросов       | Работа с индексами                                   | ДЗ сдано        | 12             |
| Леонид            | Ильич              | Виды и устройство репликации в PostgreSQL. Практика применения | Репликация                                           | ДЗ сдано        | 15             |
| Александр         | Николаевич         | Сбор и использование статистики                                | Работа с join'ами, статистикой                       | ДЗ сдано        | 17             |
| Никита            | Сергеевич          | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |
| Михаил            | Федорович          | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |
| Владимир          | Ильич              | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |
| Василий           | Иванович           | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |

4. Реализовать полное соединение (full join). Реализую показ обучающихся, которые работают в компаниях из таблицы компаний, но также отоброжение компаний в которых отсутствуют обучающиеся:
```SQL
select
    s."lastName" ,
    s."firstName" ,
    s."patronymic" ,
    c."name" as "companyName"
from otus.student s
full join otus.company c
on s."companyId" = c.id 
```
**Результат**

| lastName  | firstName  | patronymic    | companyName   |
|-----------|------------|---------------|---------------|
| Иванов    | Пётр       | Алексеевич    | Яндекс        |
| Кузнецов  | Иван       | Васильевич    |               |
| Попов     | Николай    | Павлович      | Ozon          |
| Васильев  | Михаил     | Федорович     | Сбербанк      |
| Петров    | Борис      | Николаевич    |               |
| Соколов   | Леонид     | Ильич         | Рамблер       |
| Михайлов  | Александр  | Николаевич    | Т-банк        |
| Фёдоров   | Павел      | Петрович      |               |
| Волков    | Владимир   | Ильич         | 1С            |
| Алексеев  | Никита     | Сергеевич     |               |
| Лебедев   | Борис      | Федорович     | МТС           |
| Семенов   | Александр  | Александрович |               |
| Егоров    | Василий    | Иванович      | Газпром нефть |
| Павлов    | Федор      | Алексеевич    | Мегафон       |
| Смирнов   | Алексей    | Михайлович    | Яндекс        |
|           |            |               | Mail.ru Group |

5. Реализовать запрос, в котором будут использованы разные типы соединений. Для этого объеденю 3ый и 4ий запрос (вместо full сделаю left)
```SQL

select
    s."lastName" 	as "studentLastName",
    s."firstName" 	as "studentFirstName",
    s.patronymic	as "studentPatronymic",
    c."name"  		as "compannyName",
    l."name" 		as "lectureName",
    h."text" 		as "homeworkText",
    case when hs.score is null then 'ДЗ не сдано'
         else 'ДЗ сдано'
        end 	 		as "homeworkStatus",
    hs.score 		as "homeworkScore"
from otus.student s
         left join otus.company c
                   on c.id = s."companyId"
         cross join otus.lecture l
         left join otus.homework h
                   on l.id = h."lectureId"
         left join otus."homeworkStatus" hs
                   on hs."studentId" = s.id
                       and hs."homeworkId" = h.id
order by case when hs.score is null then 2
              else 1 end,
         l.id,
         s."lastName"

```
**Результат (частичный тк весь результат занимает 360 строк)**

| studentLastName  | studentFirstName  | studentPatronymic  | compannyName  | lectureName                                                    | homeworkText                                         | homeworkStatus  | homeworkScore  |
|------------------|-------------------|--------------------|---------------|----------------------------------------------------------------|------------------------------------------------------|-----------------|----------------|
| Иванов           | Пётр              | Алексеевич         | Яндекс        | SQL и реляционные СУБД. Введение в PostgreSQL                  | Работа с уровнями изоляции транзакции в PostgreSQL   | ДЗ сдано        | 15             |
| Смирнов          | Алексей           | Михайлович         | Яндекс        | SQL и реляционные СУБД. Введение в PostgreSQL                  | Работа с уровнями изоляции транзакции в PostgreSQL   | ДЗ сдано        | 10             |
| Попов            | Николай           | Павлович           | Ozon          | Установка PostgreSQL                                           | Установка и настройка PostgteSQL в контейнере Docker | ДЗ сдано        | 15             |
| Смирнов          | Алексей           | Михайлович         | Яндекс        | Физический уровень PostgreSQL                                  | Установка и настройка PostgreSQL                     | ДЗ сдано        | 10             |
| Кузнецов         | Иван              | Васильевич         |               | Логический уровень PostgreSQL                                  | Работа с базами данных, пользователями и правами     | ДЗ сдано        | 17             |
| Попов            | Николай           | Павлович           | Ozon          | Настройка PostgreSQL                                           | Нагрузочное тестирование и тюнинг PostgreSQL         | ДЗ сдано        | 8              |
| Васильев         | Михаил            | Федорович          | Сбербанк      | MVCC, vacuum и autovacuum                                      | Механизм блокировок                                  | ДЗ сдано        | 10             |
| Петров           | Борис             | Николаевич         |               | Виды индексов. Работа с индексами и оптимизация запросов       | Работа с индексами                                   | ДЗ сдано        | 12             |
| Соколов          | Леонид            | Ильич              | Рамблер       | Виды и устройство репликации в PostgreSQL. Практика применения | Репликация                                           | ДЗ сдано        | 15             |
| Михайлов         | Александр         | Николаевич         | Т-банк        | Сбор и использование статистики                                | Работа с join'ами, статистикой                       | ДЗ сдано        | 17             |
| Алексеев         | Никита            | Сергеевич          |               | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |
| Васильев         | Михаил            | Федорович          | Сбербанк      | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |
| Волков           | Владимир          | Ильич              | 1С            | Реляционные базы, история и место в современном мире           |                                                      | ДЗ не сдано     |                |

